<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚀 AI Mail Generator</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body { background-color: #f8f9fa; }
        .container { max-width: 800px; margin-top: 50px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); }
        textarea { width: 100%; height: 150px; resize: none; font-size: 16px; }
        .history-box { background: #fff; padding: 15px; border-radius: 10px; box-shadow: 0 0 5px rgba(0, 0, 0, 0.1); display: none; }
        .loader { display: none; margin: 10px auto; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <h2 class="text-center text-primary">🚀 AI Mail Generator</h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="d-flex justify-content-between mb-3">
        <span>Welcome, <b>{{ session['user'] }}</b></span>
        <div>
            <a href="{{ url_for('profile') }}" class="btn btn-info btn-sm">Profile</a>
            <a href="{{ url_for('logout') }}" class="btn btn-danger btn-sm">Logout</a>
        </div>
    </div>

    <div class="input-group mb-3">
        <input type="text" id="title" class="form-control" placeholder="✍️ Enter email topic...">
        <button class="btn btn-primary" onclick="generateEmail()">✨ Generate</button>
    </div>

    <!-- Loader -->
    <div class="text-center">
        <div id="loader" class="loader"></div>
    </div>

    <h4 class="mt-4">📧 Generated Email:</h4>
    <textarea id="generatedEmail" class="form-control" readonly></textarea>

    <div class="text-center mt-3">
        <button class="btn btn-success" onclick="copyText()">📋 Copy</button>
        <button class="btn btn-secondary" onclick="toggleHistory()">📜 History</button>
    </div>

    <div id="historySection" class="mt-4" style="display: none;">
        <h4>📌 Email History</h4>
        <div id="historyBox" class="history-box"></div>
    </div>
</div>

<script>
    function generateEmail() {
        let title = document.getElementById("title").value.trim();
        if (!title) {
            alert("⚠️ Please enter a topic.");
            return;
        }

        document.getElementById("loader").style.display = "block";

        fetch('/generate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({title: title})
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById("loader").style.display = "none";

            if (data.error) {
                alert("⚠️ " + data.error);
            } else {
                document.getElementById("generatedEmail").value = data.email;
                // Hide history section when generating a new email
                document.getElementById("historySection").style.display = "none";
            }
        })
        .catch(error => {
            document.getElementById("loader").style.display = "none";
            console.error('Error:', error);
        });
    }

    function copyText() {
        let textarea = document.getElementById("generatedEmail");
        navigator.clipboard.writeText(textarea.value).then(() => {
            alert("✅ Copied to clipboard!");
        });
    }

    function showHistory() {
        fetch('/history')
        .then(response => response.json())
        .then(data => {
            let historyBox = document.getElementById("historyBox");
            historyBox.innerHTML = "";
            historyBox.style.display = "block";  // Ensure history is visible

            if (!data.history || data.history.length === 0) {
                historyBox.innerHTML = "<p class='text-center text-muted'>No email history found.</p>";
            } else {
                data.history.forEach(item => {
                    historyBox.innerHTML += `
                        <div class="p-3 mb-3 border rounded">
                            <h5 class="text-primary">📌 ${item.title}</h5>
                            <p class="text-muted">${item.email.replace(/\n/g, "<br>")}</p>
                            <button class="btn btn-danger btn-sm" onclick="deleteEmail('${item.title}')">🗑️ Delete</button>
                        </div>`;
                });
            }
        })
        .catch(error => console.error('Error:', error));
    }

    function toggleHistory() {
        let historySection = document.getElementById("historySection");
    
        if (historySection.style.display === "none") {
            console.log("Fetching history...");  // Debugging
            showHistory();  // Fetch and display history
            historySection.style.display = "block";  // Show history section
        } else {
            console.log("Hiding history...");  // Debugging
            historySection.style.display = "none";  // Hide history
        }
    }
    

    function deleteEmail(title) {
        fetch('/delete_email', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({title: title})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert("✅ Email deleted successfully!");
                showHistory();
            } else {
                alert("❌ Error deleting email.");
            }
        })
        .catch(error => console.error('Error:', error));
    }
</script>

</body>
</html>